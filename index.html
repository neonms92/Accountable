<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Budget Ledger</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=Crimson+Pro:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://accounts.google.com/gsi/client"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="message-container" id="messageContainer"></div>

    <!-- 
        Todo:
        Statements
            Each account has a statement each month which declares the starting balance, ending balance, dates covered, total deposits, and total withdrawals for the month
            Simple sanity checking with deposit/withdrawal totals and starting/ending balances
        Transaction conditions
            Transactions are complete for the month once account withdrawal totals match statement totals for the month
            Transactions must also have envelopes assigned to be complete for the month
        Refactor Envelopes
            Added explicitly, not inferred from Transactions
            Transactions deduct from envelope balance
            Envelopes have manual or automatic funding rules
            Envelopes are complete for the month once total funding matches account balance totals
        Paycheck tracking
            Complete for the month once account deposit totals match statement totals for the month
        Import generator with merchant lookup
            Seperate application that generates CSVs for importing based on user-provided rules and historical transaction data
        Goals
            Set target amounts for envelopes and track progress
        Charts
            Spending by envelope over time
            Account balances over time
    -->

    <header>
        <div class="header-content">
            <h1>Personal Budget Ledger</h1>
            <div class="file-controls">
                <div id="driveStatus" class="drive-status" title="Google Drive not connected">
                    <div class="drive-status-dot"></div>
                    <span id="driveStatusText">Drive</span>
                </div>
                <div id="unsavedIndicator" class="unsaved-status" title="Unsaved changes" style="display:none;">
                    <div class="unsaved-status-dot"></div>
                    <span id="unsavedIndicatorText">Unsaved</span>
                </div>
                <button onclick="openFileMenu()">File</button>
            </div>
        </div>
    </header>

    <div class="controls-bar">
        <div class="month-selector">
            <label for="monthSelect">Month:</label>
            <select id="monthSelect" onchange="onMonthChange()">
                <option value="">All Months</option>
            </select>
        </div>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="switchTab('summary')">Summary</button>
        <button class="tab" onclick="switchTab('accounts')">Accounts</button>
        <button class="tab" onclick="switchTab('statements')">Statements</button>
        <button class="tab" onclick="switchTab('envelopes')">Envelopes</button>
        <button class="tab" onclick="switchTab('transactions')">Transactions</button>
    </div>

    <main>
        <div id="summaryTab" class="tab-content active">
            <div class="summary-grid">
                <div class="summary-card">
                    <div class="summary-card-header">Net Worth</div>
                    <div class="summary-card-subheader">Year to Date</div>
                    <div class="summary-value" id="netWorthYTD">$0.00</div>
                    <div class="summary-delta" id="netWorthDelta">$0.00</div>
                </div>
                <div class="summary-card">
                    <div class="summary-card-header">Total Assets</div>
                    <div class="summary-card-subheader">Year to Date</div>
                    <div class="summary-value positive" id="totalAssetsYTD">$0.00</div>
                    <div class="summary-delta" id="totalAssetsDelta">$0.00</div>
                </div>
                <div class="summary-card">
                    <div class="summary-card-header">Total Liabilities</div>
                    <div class="summary-card-subheader">Year to Date</div>
                    <div class="summary-value negative" id="totalLiabilitiesYTD">$0.00</div>
                    <div class="summary-delta" id="totalLiabilitiesDelta">$0.00</div>
                </div>
            </div>
        </div>

        <div id="accountsTab" class="tab-content">
            <section>
                <div class="section-header">
                    <h2 class="section-title">Accounts</h2>
                    <button onclick="openAccountModal()">+ Add Account</button>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th class="sortable" onclick="sortTable('accounts', 'name')">Account Name</th>
                                <th class="sortable" style="text-align: right;" onclick="sortTable('accounts', 'balance')">Balance (YTD)</th>
                            </tr>
                        </thead>
                        <tbody id="accountsBody"></tbody>
                    </table>
                </div>
            </section>
        </div>

        <div id="statementsTab" class="tab-content">
            <section>
                <div class="section-header">
                    <h2 class="section-title">Statements</h2>
                    <button onclick="openStatementModal()">+ Add Statement</button>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Account</th>
                                <th style="text-align: right;">Starting Balance</th>
                                <th style="text-align: right;">Ending Balance</th>
                                <th style="text-align: right;">Total Deposits</th>
                                <th style="text-align: right;">Total Withdrawals</th>
                                <th>Period</th>
                                <th style="text-align: center;">Status</th>
                            </tr>
                        </thead>
                        <tbody id="statementsBody"></tbody>
                    </table>
                </div>
            </section>
        </div>

        <div id="envelopesTab" class="tab-content">
            <section>
                <div class="section-header">
                    <h2 class="section-title">Envelopes</h2>
                    <button onclick="openEnvelopeModal()">+ Add Envelope</button>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th class="sortable" onclick="sortTable('envelopes', 'name')">Envelope</th>
                                <th class="sortable" style="text-align: right;" onclick="sortTable('envelopes', 'funding')">Funding</th>
                                <th class="sortable" style="text-align: right;" onclick="sortTable('envelopes', 'withdrawals')">Withdrawals</th>
                                <th class="sortable" style="text-align: right;" onclick="sortTable('envelopes', 'total')">Total</th>
                            </tr>
                        </thead>
                        <tbody id="envelopesBody"></tbody>
                    </table>
                </div>
            </section>
        </div>

        <div id="transactionsTab" class="tab-content">
            <section>
                <div class="section-header">
                    <h2 class="section-title">Transactions</h2>
                    <div class="action-row">
                        <button onclick="importCSV()" class="secondary">Import CSV</button>
                        <button onclick="openTransactionModal()" class="secondary">+ Add Transaction</button>
                        <button onclick="openTransferModal()" class="secondary">↔ Transfer</button>
                    </div>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 40px;"><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                                <th class="sortable" onclick="sortTable('transactions', 'date')">Date</th>
                                <th class="sortable" onclick="sortTable('transactions', 'month')">Month</th>
                                <th class="sortable" onclick="sortTable('transactions', 'account')">Account</th>
                                <th class="sortable" onclick="sortTable('transactions', 'description')">Description</th>
                                <th class="sortable" onclick="sortTable('transactions', 'envelope')">Envelope</th>
                                <th class="sortable" style="text-align: right;" onclick="sortTable('transactions', 'amount')">Amount</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsBody"></tbody>
                    </table>
                </div>
                <div id="selectionBar" class="selection-bar" style="display: none;">
                    <div class="selection-info">
                        <strong><span id="selectionCount">0</span> selected</strong> | Total: <strong><span id="selectionSum">$0.00</span></strong>
                    </div>
                    <button onclick="confirmDeleteSelected()" class="danger">Delete Selected</button>
                </div>
            </section>
        </div>
    </main>

    <div id="fileMenuModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">File Menu</h3>
            </div>
            <div class="modal-body">
                <span class="file-name" id="fileName">No file loaded</span>
                <br/>
                <button onclick="openDriveOpenModal()" class="secondary">Open from Google Drive</button>
                <button onclick="openDriveSaveModal()" class="secondary">Save to Google Drive</button>
                <button onclick="openFile()" class="secondary">Open Local File</button>
                <button onclick="saveFile()" class="secondary">Save Local File</button>
            </div>
            <div class="modal-footer">
                <div class="modal-footer-left"></div>
                <div class="modal-footer-right">
                    <button onclick="closeFileMenuModal()" class="secondary">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div id="accountModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="accountModalTitle">Add Account</h3>
            </div>
            <div class="modal-body">
                <form id="accountForm">
                    <input type="hidden" id="accountId">
                    <div class="form-group">
                        <label for="accountName">Account Name</label>
                        <input type="text" id="accountName" placeholder="e.g., Checking Account" required>
                    </div>
                    <div class="form-group">
                        <label for="accountBalance">Initial Balance</label>
                        <input type="number" id="accountBalance" step="0.01" value="0.00" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <div class="modal-footer-left">
                    <button id="deleteAccountBtn" onclick="confirmDeleteAccount()" class="danger" style="display: none;">Delete</button>
                </div>
                <div class="modal-footer-right">
                    <button onclick="closeAccountModal()" class="secondary">Cancel</button>
                    <button onclick="saveAccount()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <div id="transactionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="transactionModalTitle">Add Transaction</h3>
            </div>
            <div class="modal-body">
                <form id="transactionForm">
                    <input type="hidden" id="transactionId">
                    <div class="form-group">
                        <label for="transactionDate">Date</label>
                        <input type="date" id="transactionDate" required>
                    </div>
                    <div class="form-group">
                        <label for="transactionMonth">Month</label>
                        <select id="transactionMonth" required>
                            <option value="">Select month...</option>
                            <option value="1">January</option>
                            <option value="2">February</option>
                            <option value="3">March</option>
                            <option value="4">April</option>
                            <option value="5">May</option>
                            <option value="6">June</option>
                            <option value="7">July</option>
                            <option value="8">August</option>
                            <option value="9">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="transactionAccount">Account</label>
                        <select id="transactionAccount" required></select>
                    </div>
                    <div class="form-group">
                        <label for="transactionAmount">Amount</label>
                        <input type="number" id="transactionAmount" step="0.01" placeholder="Positive for income, negative for expense" required>
                    </div>
                    <div class="form-group">
                        <label for="transactionDescription">Description</label>
                        <input type="text" id="transactionDescription" placeholder="e.g., Grocery shopping" required>
                    </div>
                    <div class="form-group">
                        <label for="transactionEnvelope">Envelope</label>
                        <select id="transactionEnvelope"></select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <div class="modal-footer-left">
                    <button id="deleteTransactionBtn" onclick="confirmDeleteTransaction()" class="danger" style="display: none;">Delete</button>
                </div>
                <div class="modal-footer-right">
                    <button onclick="closeTransactionModal()" class="secondary">Cancel</button>
                    <button onclick="saveTransaction()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <div id="transferModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Transfer Between Accounts</h3>
            </div>
            <div class="modal-body">
                <form id="transferForm">
                    <div class="form-group">
                        <label for="transferDate">Date</label>
                        <input type="date" id="transferDate" required>
                    </div>
                    <div class="form-group">
                        <label for="transferMonth">Month</label>
                        <select id="transferMonth" required>
                            <option value="">Select month...</option>
                            <option value="1">January</option>
                            <option value="2">February</option>
                            <option value="3">March</option>
                            <option value="4">April</option>
                            <option value="5">May</option>
                            <option value="6">June</option>
                            <option value="7">July</option>
                            <option value="8">August</option>
                            <option value="9">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="transferFrom">From Account</label>
                        <select id="transferFrom" required></select>
                    </div>
                    <div class="form-group">
                        <label for="transferTo">To Account</label>
                        <select id="transferTo" required></select>
                    </div>
                    <div class="form-group">
                        <label for="transferAmount">Amount</label>
                        <input type="number" id="transferAmount" step="0.01" min="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="transferDescription">Description</label>
                        <input type="text" id="transferDescription" placeholder="e.g., Transfer to savings" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <div class="modal-footer-left"></div>
                <div class="modal-footer-right">
                    <button onclick="closeTransferModal()" class="secondary">Cancel</button>
                    <button onclick="addTransfer()">Add Transfer</button>
                </div>
            </div>
        </div>
    </div>

    <div id="statementModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="statementModalTitle">Add Statement</h3>
            </div>
            <div class="modal-body">
                <form id="statementForm">
                    <input type="hidden" id="statementId">
                    <div class="form-group">
                        <label for="statementAccount">Account</label>
                        <select id="statementAccount" required></select>
                    </div>
                    <div class="form-group">
                        <label for="statementMonth">Month</label>
                        <select id="statementMonth" required>
                            <option value="">Select month...</option>
                            <option value="1">January</option>
                            <option value="2">February</option>
                            <option value="3">March</option>
                            <option value="4">April</option>
                            <option value="5">May</option>
                            <option value="6">June</option>
                            <option value="7">July</option>
                            <option value="8">August</option>
                            <option value="9">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="statementStartDate">Start Date</label>
                            <input type="date" id="statementStartDate" required>
                        </div>
                        <div class="form-group">
                            <label for="statementEndDate">End Date</label>
                            <input type="date" id="statementEndDate" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="statementStartBalance">Starting Balance</label>
                            <input type="number" id="statementStartBalance" step="0.01" placeholder="0.00" required>
                        </div>
                        <div class="form-group">
                            <label for="statementEndBalance">Ending Balance</label>
                            <input type="number" id="statementEndBalance" step="0.01" placeholder="0.00" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="statementDeposits">Total Deposits</label>
                            <input type="number" id="statementDeposits" step="0.01" min="0" placeholder="0.00" required>
                        </div>
                        <div class="form-group">
                            <label for="statementWithdrawals">Total Withdrawals</label>
                            <input type="number" id="statementWithdrawals" step="0.01" min="0" placeholder="0.00" required>
                        </div>
                    </div>
                    <div id="statementSanityCheck" class="statement-sanity" style="display:none;"></div>
                </form>
            </div>
            <div class="modal-footer">
                <div class="modal-footer-left">
                    <button id="deleteStatementBtn" onclick="confirmDeleteStatement()" class="danger" style="display:none;">Delete</button>
                </div>
                <div class="modal-footer-right">
                    <button onclick="closeStatementModal()" class="secondary">Cancel</button>
                    <button onclick="saveStatement()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <div id="envelopeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="envelopeModalTitle">Add Envelope</h3>
            </div>
            <div class="modal-body">
                <form id="envelopeForm">
                    <input type="hidden" id="envelopeId">
                    <div class="form-group">
                        <label for="envelopeName">Name</label>
                        <input type="text" id="envelopeName" placeholder="e.g., Groceries, Utilities" required>
                    </div>
                    <div class="form-group">
                        <label>Color</label>
                        <div class="color-picker-group">
                            <div class="color-presets">
                                <button type="button" class="color-preset" style="background: #2D5F3F;" data-color="#2D5F3F"></button>
                                <button type="button" class="color-preset" style="background: #3B82F6;" data-color="#3B82F6"></button>
                                <button type="button" class="color-preset" style="background: #8B5CF6;" data-color="#8B5CF6"></button>
                                <button type="button" class="color-preset" style="background: #EC4899;" data-color="#EC4899"></button>
                                <button type="button" class="color-preset" style="background: #F59E0B;" data-color="#F59E0B"></button>
                                <button type="button" class="color-preset" style="background: #EF4444;" data-color="#EF4444"></button>
                            </div>
                            <div class="color-hex-input">
                                <input type="text" id="envelopeModalColorHex" placeholder="#000000" maxlength="7">
                                <div class="color-preview" id="envelopeModalColorPreview" style="background: #2D5F3F;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group" id="envelopeFundingGroup">
                        <label for="envelopeFunding" id="envelopeFundingLabel">Funding <span id="envelopeFundingMonthLabel"></span></label>
                        <input type="number" id="envelopeFunding" step="0.01" min="0" placeholder="0.00">
                        <div id="envelopeFundingHint" class="field-hint"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <div class="modal-footer-left">
                    <button id="deleteEnvelopeBtn" onclick="confirmDeleteEnvelope()" class="danger" style="display:none;">Delete</button>
                </div>
                <div class="modal-footer-right">
                    <button onclick="closeEnvelopeModal()" class="secondary">Cancel</button>
                    <button onclick="saveEnvelope()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="confirmModalTitle">Confirm Action</h3>
            </div>
            <div class="modal-body" id="confirmModalBody"></div>
            <div class="modal-footer">
                <div class="modal-footer-left"></div>
                <div class="modal-footer-right">
                    <button onclick="closeConfirmModal()" class="secondary">Cancel</button>
                    <button onclick="executeConfirmAction()" id="confirmActionBtn">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <div id="driveOpenModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Open from Google Drive</h3>
            </div>
            <div class="modal-body">
                <div class="drive-setup-note" id="driveSetupNote" style="display:none;">
                    ⚠️ <strong>Google OAuth setup required</strong>
                    <br><br>
                    1. Add your page URL to <strong>Authorized JavaScript origins</strong> in Google Cloud Console:<br>
                    <code>https://yourusername.github.io</code> (for GitHub Pages)<br>
                    <code>http://localhost:8080</code> (for local testing)<br>
                    <br>
                    2. Enable <strong>Google Drive API</strong> in your Google Cloud project.<br>
                    <br>
                    3. If still failing, check browser console for errors.
                </div>
                <div id="driveOpenContent">
                    <p style="color: var(--color-ink-muted); margin-bottom: 1rem; font-size: 0.875rem;">Files in <strong>/Accountable</strong> on Google Drive:</p>
                    <div id="driveFileList" class="drive-file-list">
                        <div class="drive-empty">Connect to Google Drive to browse files.</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div class="modal-footer-left"></div>
                <div class="modal-footer-right">
                    <button onclick="closeDriveOpenModal()" class="secondary">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <div id="driveSaveModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Save to Google Drive</h3>
            </div>
            <div class="modal-body">
                <p style="color: var(--color-ink-muted); margin-bottom: 1.5rem; font-size: 0.875rem;">Saving to <strong>/Accountable</strong> on Google Drive.</p>
                <div class="form-group">
                    <label for="driveSaveFileName">File Name</label>
                    <input type="text" id="driveSaveFileName" value="data.json">
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="driveRenameExisting" checked>
                    <label for="driveRenameExisting">Rename existing file with date before overwriting</label>
                </div>
                <div id="driveRenamePreview" style="font-size:0.8rem; color: var(--color-ink-muted); margin-top: 0.5rem; padding-left: 1.75rem;"></div>
            </div>
            <div class="modal-footer">
                <div class="modal-footer-left"></div>
                <div class="modal-footer-right">
                    <button onclick="closeDriveSaveModal()" class="secondary">Cancel</button>
                    <button onclick="executeDriveSave()" id="driveSaveBtn">Save to Drive</button>
                </div>
            </div>
        </div>
    </div>

    <script src="gdrive.js"></script>
    <script>
        // ─── Application State ───────────────────────────────────────────────────────
        let ledgerData = { accounts: [], transactions: [], envelopes: {}, statements: [], fileName: null };
        let selectedMonth = null;
        let selectedEnvelopeColor = '#2D5F3F';
        let envelopeModalColor = '#2D5F3F';
        let sortState = { table: null, column: null, direction: 'asc' };
        let selectedTransactions = new Set();
        let lastSelectedIndex = -1;
        let pendingAction = null;

        function init() {
            setTodayDate();
            populateMonthSelector();
            setupColorPicker();
            setupKeyboardShortcuts();
            updateUI();
            driveInit();
        }

        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('transactionDate').value = today;
            document.getElementById('transferDate').value = today;
            const currentMonth = new Date().getMonth() + 1;
            document.getElementById('transactionMonth').value = currentMonth.toString();
            document.getElementById('transferMonth').value = currentMonth.toString();
        }

        function populateMonthSelector() {
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            const select = document.getElementById('monthSelect');
            select.innerHTML = '<option value="">All Months</option>';
            months.forEach((month, i) => {
                const opt = document.createElement('option');
                opt.value = (i + 1).toString();
                opt.textContent = month;
                select.appendChild(opt);
            });
        }

        function setupColorPicker() {
            // Envelope modal color picker is wired in openEnvelopeModal dynamically
        }

        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowUp' && e.shiftKey) {
                    e.preventDefault();
                    moveSelection(-1);
                } else if (e.key === 'ArrowDown' && e.shiftKey) {
                    e.preventDefault();
                    moveSelection(1);
                }
            });
        }

        function moveSelection(direction) {
            const rows = Array.from(document.querySelectorAll('#transactionsBody tr'));
            if (rows.length === 0 || lastSelectedIndex === -1) return;
            
            const newIndex = Math.max(0, Math.min(rows.length - 1, lastSelectedIndex + direction));
            const row = rows[newIndex];
            const checkbox = row.querySelector('input[type="checkbox"]');
            if (checkbox) {
                checkbox.checked = true;
                const transId = checkbox.dataset.id;
                selectedTransactions.add(transId);
                lastSelectedIndex = newIndex;
                updateSelectionUI();
            }
        }

        function selectColor(color) {
            selectedEnvelopeColor = color;
        }

        function selectEnvelopeModalColor(color) {
            envelopeModalColor = color;
            document.getElementById('envelopeModalColorPreview').style.background = color;
            document.getElementById('envelopeModalColorHex').value = color;
            document.querySelectorAll('#envelopeModal .color-preset').forEach(btn => {
                btn.classList.toggle('selected', btn.dataset.color.toLowerCase() === color.toLowerCase());
            });
        }

        function onEnvelopeSelectChange() {
            // no-op: inline envelope creation removed
        }

        function showMessage(msg, type = 'success') {
            const div = document.createElement('div');
            div.className = type === 'success' ? 'floating-message success' : 'floating-message error';
            div.textContent = msg;
            div.onclick = () => div.remove();
            document.getElementById('messageContainer').appendChild(div);
            setTimeout(() => div.remove(), 5000);
        }

        function switchTab(name) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(name + 'Tab').classList.add('active');
        }

        function onMonthChange() {
            selectedMonth = document.getElementById('monthSelect').value ? parseInt(document.getElementById('monthSelect').value) : null;
            updateUI();
        }

        function openFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            ledgerData = JSON.parse(event.target.result);
                            ledgerData.fileName = file.name;
                            if (!ledgerData.envelopes) ledgerData.envelopes = {};
                            if (!ledgerData.statements) ledgerData.statements = [];
                            // Migrate envelopes: ensure all have a funding object
                            Object.keys(ledgerData.envelopes).forEach(name => {
                                if (!ledgerData.envelopes[name].funding) ledgerData.envelopes[name].funding = {};
                            });
                            updateUI();
                            showMessage('File loaded successfully!');
                        } catch {
                            showMessage('Error loading file: Invalid JSON format', 'error');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function saveFile() {
            const dataStr = JSON.stringify(ledgerData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = ledgerData.fileName || 'budget-ledger.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            setTimeout(() => URL.revokeObjectURL(url), 100);
            markSaved();
            showMessage('File saved successfully!');
        }

        let hasUnsavedChanges = false;

        function markUnsaved() {
            hasUnsavedChanges = true;
            updateUnsavedIndicator();
        }

        function markSaved() {
            hasUnsavedChanges = false;
            updateUnsavedIndicator();
        }

        function updateUnsavedIndicator() {
            const indicator = document.getElementById('unsavedIndicator');
            if (indicator) {
                indicator.style.display = hasUnsavedChanges ? 'inline' : 'none';
            }
        }

        function importCSV() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            parseCSV(event.target.result);
                        } catch (error) {
                            showMessage('Error parsing CSV: ' + error.message, 'error');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function parseCSV(text) {
            const lines = text.trim().split('\n');
            if (lines.length < 2) {
                showMessage('CSV file is empty or invalid', 'error');
                return;
            }

            const header = lines[0].split(',').map(h => h.trim().toLowerCase());
            const requiredFields = ['date', 'account', 'amount', 'description'];
            const missing = requiredFields.filter(f => !header.includes(f));
            
            if (missing.length > 0) {
                showMessage('CSV missing required columns: ' + missing.join(', '), 'error');
                return;
            }

            const newTransactions = [];
            const newAccounts = new Set();
            const newEnvelopes = new Set();

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                if (values.length < header.length) continue;

                const row = {};
                header.forEach((col, idx) => row[col] = values[idx]);

                const account = row.account;
                const envelope = row.envelope || '';
                const month = row.month ? parseInt(row.month) : new Date(row.date).getMonth() + 1;

                if (!ledgerData.accounts.find(a => a.name === account)) {
                    newAccounts.add(account);
                }

                if (envelope && !ledgerData.envelopes[envelope]) {
                    newEnvelopes.add(envelope);
                }

                newTransactions.push({
                    date: row.date,
                    month: month,
                    account: account,
                    amount: parseFloat(row.amount),
                    description: row.description,
                    envelope: envelope
                });
            }

            if (newAccounts.size > 0 || newEnvelopes.size > 0) {
                showImportConfirmModal(newTransactions, Array.from(newAccounts), Array.from(newEnvelopes));
            } else {
                finishImport(newTransactions, [], []);
            }
        }

        function showImportConfirmModal(transactions, accounts, envelopes) {
            pendingAction = { type: 'import', transactions, accounts, envelopes };
            
            let html = '<p>The CSV contains the following new items:</p>';
            
            if (accounts.length > 0) {
                html += '<div class="confirmation-list"><div class="confirmation-list-title">New Accounts:</div><ul>';
                accounts.forEach(a => html += `<li>${escapeHtml(a)}</li>`);
                html += '</ul></div>';
            }

            if (envelopes.length > 0) {
                html += '<div class="confirmation-list"><div class="confirmation-list-title">New Envelopes:</div><ul>';
                envelopes.forEach(e => html += `<li>${escapeHtml(e)}</li>`);
                html += '</ul></div>';
            }

            html += `<p>Import ${transactions.length} transaction(s)?</p>`;

            document.getElementById('confirmModalTitle').textContent = 'Confirm Import';
            document.getElementById('confirmModalBody').innerHTML = html;
            document.getElementById('confirmActionBtn').textContent = 'Confirm Import';
            document.getElementById('confirmModal').classList.add('active');
        }

        function finishImport(transactions, accounts, envelopes) {
            accounts.forEach(name => {
                ledgerData.accounts.push({
                    id: Date.now().toString() + Math.random(),
                    name: name,
                    initialBalance: 0
                });
            });

            envelopes.forEach(name => {
                if (!ledgerData.envelopes[name]) {
                    ledgerData.envelopes[name] = { color: '#2D5F3F', funding: {} };
                }
            });

            transactions.forEach(t => {
                const account = ledgerData.accounts.find(a => a.name === t.account);
                if (account) {
                    ledgerData.transactions.push({
                        id: Date.now().toString() + Math.random(),
                        date: t.date,
                        month: t.month,
                        accountId: account.id,
                        amount: t.amount,
                        description: t.description,
                        envelope: t.envelope
                    });
                }
            });

            updateUI();
            showMessage(`Imported ${transactions.length} transaction(s)`);
        }

        function confirmDeleteAccount() {
            const id = document.getElementById('accountId').value;
            if (!id) return;
            
            pendingAction = { type: 'deleteAccount', id };
            document.getElementById('confirmModalTitle').textContent = 'Delete Account';
            document.getElementById('confirmModalBody').innerHTML = '<p>Are you sure you want to delete this account? All associated transactions will also be deleted.</p>';
            document.getElementById('confirmActionBtn').textContent = 'Delete Account';
            document.getElementById('confirmActionBtn').className = 'danger';
            document.getElementById('confirmModal').classList.add('active');
        }

        function confirmDeleteTransaction() {
            const id = document.getElementById('transactionId').value;
            if (!id) return;
            
            pendingAction = { type: 'deleteTransaction', id };
            document.getElementById('confirmModalTitle').textContent = 'Delete Transaction';
            document.getElementById('confirmModalBody').innerHTML = '<p>Are you sure you want to delete this transaction?</p>';
            document.getElementById('confirmActionBtn').textContent = 'Delete Transaction';
            document.getElementById('confirmActionBtn').className = 'danger';
            document.getElementById('confirmModal').classList.add('active');
        }

        function confirmDeleteSelected() {
            if (selectedTransactions.size === 0) return;
            
            pendingAction = { type: 'deleteSelected' };
            document.getElementById('confirmModalTitle').textContent = 'Delete Selected';
            document.getElementById('confirmModalBody').innerHTML = `<p>Are you sure you want to delete ${selectedTransactions.size} selected transaction(s)?</p>`;
            document.getElementById('confirmActionBtn').textContent = 'Delete Selected';
            document.getElementById('confirmActionBtn').className = 'danger';
            document.getElementById('confirmModal').classList.add('active');
        }

        function closeConfirmModal() {
            document.getElementById('confirmModal').classList.remove('active');
            document.getElementById('confirmActionBtn').className = '';
            pendingAction = null;
        }

        function executeConfirmAction() {
            if (!pendingAction) return;

            switch (pendingAction.type) {
                case 'import':
                    finishImport(pendingAction.transactions, pendingAction.accounts, pendingAction.envelopes);
                    break;
                case 'deleteAccount':
                    ledgerData.accounts = ledgerData.accounts.filter(a => a.id !== pendingAction.id);
                    ledgerData.transactions = ledgerData.transactions.filter(t => t.accountId !== pendingAction.id);
                    markUnsaved();
                    updateUI();
                    closeAccountModal();
                    showMessage('Account deleted successfully!');
                    break;
                case 'deleteTransaction':
                    ledgerData.transactions = ledgerData.transactions.filter(t => t.id !== pendingAction.id);
                    markUnsaved();
                    updateUI();
                    closeTransactionModal();
                    showMessage('Transaction deleted successfully!');
                    break;
                case 'deleteSelected':
                    ledgerData.transactions = ledgerData.transactions.filter(t => !selectedTransactions.has(t.id));
                    selectedTransactions.clear();
                    lastSelectedIndex = -1;
                    markUnsaved();
                    updateUI();
                    showMessage('Selected transactions deleted successfully!');
                    break;
                case 'deleteStatement':
                    ledgerData.statements = (ledgerData.statements || []).filter(s => s.id !== pendingAction.id);
                    markUnsaved();
                    updateUI();
                    closeStatementModal();
                    showMessage('Statement deleted successfully!');
                    break;
                case 'deleteEnvelope':
                    // Remove envelope entity
                    delete ledgerData.envelopes[pendingAction.name];
                    // Clear envelope from transactions
                    ledgerData.transactions.forEach(t => {
                        if (t.envelope === pendingAction.name) t.envelope = '';
                    });
                    markUnsaved();
                    updateUI();
                    closeEnvelopeModal();
                    showMessage('Envelope deleted!');
                    break;
            }

            closeConfirmModal();
        }

        function openFileMenu() {
            document.getElementById('fileMenuModal').classList.add('active');
        }
        function closeFileMenuModal() {
            document.getElementById('fileMenuModal').classList.remove('active');
        }

        function openAccountModal(accountId = null) {
            if (accountId) {
                const account = ledgerData.accounts.find(a => a.id === accountId);
                if (account) {
                    document.getElementById('accountModalTitle').textContent = 'Edit Account';
                    document.getElementById('accountId').value = account.id;
                    document.getElementById('accountName').value = account.name;
                    document.getElementById('accountBalance').value = account.initialBalance || 0;
                    document.getElementById('deleteAccountBtn').style.display = 'block';
                }
            } else {
                document.getElementById('accountModalTitle').textContent = 'Add Account';
                document.getElementById('accountId').value = '';
                document.getElementById('accountName').value = '';
                document.getElementById('accountBalance').value = '0.00';
                document.getElementById('deleteAccountBtn').style.display = 'none';
            }
            document.getElementById('accountModal').classList.add('active');
            setTimeout(() => document.getElementById('accountName').focus(), 100);
        }

        function closeAccountModal() {
            document.getElementById('accountModal').classList.remove('active');
        }

        function saveAccount() {
            const id = document.getElementById('accountId').value;
            const name = document.getElementById('accountName').value.trim();
            const balance = parseFloat(document.getElementById('accountBalance').value);
            
            if (!name) return showMessage('Please enter an account name', 'error');

            if (id) {
                const account = ledgerData.accounts.find(a => a.id === id);
                if (account) {
                    account.name = name;
                    account.initialBalance = balance;
                }
            } else {
                ledgerData.accounts.push({ id: Date.now().toString(), name, initialBalance: balance });
            }

            markUnsaved();
            updateUI();
            closeAccountModal();
            showMessage(id ? 'Account updated successfully!' : 'Account added successfully!');
        }

        function openTransactionModal(transactionId = null) {
            if (ledgerData.accounts.length === 0) return showMessage('Please add an account first', 'error');
            
            if (transactionId) {
                const transaction = ledgerData.transactions.find(t => t.id === transactionId);
                if (transaction) {
                    document.getElementById('transactionModalTitle').textContent = 'Edit Transaction';
                    document.getElementById('transactionId').value = transaction.id;
                    document.getElementById('transactionDate').value = transaction.date;
                    document.getElementById('transactionMonth').value = transaction.month;
                    document.getElementById('transactionAmount').value = transaction.amount;
                    document.getElementById('transactionDescription').value = transaction.description;
                    document.getElementById('deleteTransactionBtn').style.display = 'block';
                    
                    populateAccountSelects();
                    document.getElementById('transactionAccount').value = transaction.accountId;
                    
                    populateEnvelopeSelect();
                    document.getElementById('transactionEnvelope').value = transaction.envelope || '';
                }
            } else {
                document.getElementById('transactionModalTitle').textContent = 'Add Transaction';
                document.getElementById('transactionId').value = '';
                document.getElementById('transactionForm').reset();
                setTodayDate();
                document.getElementById('deleteTransactionBtn').style.display = 'none';
                populateAccountSelects();
                populateEnvelopeSelect();
            }

            document.getElementById('transactionModal').classList.add('active');
            setTimeout(() => document.getElementById('transactionDate').focus(), 100);
        }

        function closeTransactionModal() {
            document.getElementById('transactionModal').classList.remove('active');
        }

        function populateEnvelopeSelect() {
            const select = document.getElementById('transactionEnvelope');
            const envs = Object.keys(ledgerData.envelopes || {}).sort();
            select.innerHTML = '<option value="">— No envelope —</option>';
            envs.forEach(env => {
                const opt = document.createElement('option');
                opt.value = env;
                opt.textContent = env;
                select.appendChild(opt);
            });
        }

        function saveTransaction() {
            const id = document.getElementById('transactionId').value;
            const date = document.getElementById('transactionDate').value;
            const month = parseInt(document.getElementById('transactionMonth').value);
            const accountId = document.getElementById('transactionAccount').value;
            const amount = parseFloat(document.getElementById('transactionAmount').value);
            const description = document.getElementById('transactionDescription').value.trim();
            const envelope = document.getElementById('transactionEnvelope').value;

            if (!date || !month || !accountId || !description) return showMessage('Please fill in all required fields', 'error');

            if (id) {
                const transaction = ledgerData.transactions.find(t => t.id === id);
                if (transaction) {
                    transaction.date = date;
                    transaction.month = month;
                    transaction.accountId = accountId;
                    transaction.amount = amount;
                    transaction.description = description;
                    transaction.envelope = envelope;
                }
            } else {
                ledgerData.transactions.push({ id: Date.now().toString(), date, month, accountId, amount, description, envelope });
            }

            markUnsaved();
            updateUI();
            closeTransactionModal();
            showMessage(id ? 'Transaction updated successfully!' : 'Transaction added successfully!');
        }

        function openTransferModal() {
            if (ledgerData.accounts.length < 2) return showMessage('Please add at least two accounts first', 'error');
            document.getElementById('transferModal').classList.add('active');
            populateTransferSelects();
            setTimeout(() => document.getElementById('transferDate').focus(), 100);
        }

        function closeTransferModal() {
            document.getElementById('transferModal').classList.remove('active');
        }

        function addTransfer() {
            const date = document.getElementById('transferDate').value;
            const month = parseInt(document.getElementById('transferMonth').value);
            const fromId = document.getElementById('transferFrom').value;
            const toId = document.getElementById('transferTo').value;
            const amount = parseFloat(document.getElementById('transferAmount').value);
            const description = document.getElementById('transferDescription').value.trim();

            if (!date || !month || !fromId || !toId || !description || amount <= 0) return showMessage('Please fill in all fields correctly', 'error');
            if (fromId === toId) return showMessage('Source and destination accounts must be different', 'error');

            const ts = Date.now().toString();
            ledgerData.transactions.push({ id: ts + '-from', date, month, accountId: fromId, amount: -amount, description: description + ' (Transfer Out)', envelope: 'Transfer' });
            ledgerData.transactions.push({ id: ts + '-to', date, month, accountId: toId, amount: amount, description: description + ' (Transfer In)', envelope: 'Transfer' });

            markUnsaved();
            updateUI();
            closeTransferModal();
            document.getElementById('transferForm').reset();
            setTodayDate();
            showMessage('Transfer added successfully!');
        }

        function toggleSelectAll() {
            const checked = document.getElementById('selectAll').checked;
            document.querySelectorAll('#transactionsBody input[type="checkbox"]').forEach(cb => {
                cb.checked = checked;
                if (checked) {
                    selectedTransactions.add(cb.dataset.id);
                } else {
                    selectedTransactions.delete(cb.dataset.id);
                }
            });
            updateSelectionUI();
        }

        function toggleTransaction(id, index, event) {
            if (event.target.type === 'checkbox') {
                if (event.target.checked) {
                    selectedTransactions.add(id);
                } else {
                    selectedTransactions.delete(id);
                }
                lastSelectedIndex = index;
                updateSelectionUI();
                return;
            }

            // Clicked on row - open edit modal
            openTransactionModal(id);
        }

        function handleTransactionClick(id, index, event) {
            // Stop propagation for checkbox clicks
            if (event.target.type === 'checkbox') {
                event.stopPropagation();
                const checkbox = event.target;
                
                if (event.shiftKey && lastSelectedIndex !== -1 && lastSelectedIndex !== index) {
                    const start = Math.min(lastSelectedIndex, index);
                    const end = Math.max(lastSelectedIndex, index);
                    const rows = document.querySelectorAll('#transactionsBody tr');
                    for (let i = start; i <= end; i++) {
                        const cb = rows[i].querySelector('input[type="checkbox"]');
                        if (cb) {
                            cb.checked = true;
                            selectedTransactions.add(cb.dataset.id);
                        }
                    }
                } else {
                    if (checkbox.checked) {
                        selectedTransactions.add(id);
                    } else {
                        selectedTransactions.delete(id);
                    }
                }
                
                lastSelectedIndex = index;
                updateSelectionUI();
                return;
            }

            // Clicked on row - open edit modal
            openTransactionModal(id);
        }

        function updateSelectionUI() {
            const count = selectedTransactions.size;
            
            if (count > 0) {
                const sum = Array.from(selectedTransactions).reduce((total, id) => {
                    const t = ledgerData.transactions.find(x => x.id === id);
                    return total + (t ? t.amount : 0);
                }, 0);
                
                document.getElementById('selectionCount').textContent = count;
                document.getElementById('selectionSum').textContent = formatCurrency(sum);
                document.getElementById('selectionBar').style.display = 'flex';
            } else {
                document.getElementById('selectionBar').style.display = 'none';
            }

            document.querySelectorAll('#transactionsBody tr').forEach(row => {
                const cb = row.querySelector('input[type="checkbox"]');
                row.classList.toggle('selected', cb && cb.checked);
            });

            // Update select all checkbox
            const allCheckboxes = document.querySelectorAll('#transactionsBody input[type="checkbox"]');
            const allChecked = allCheckboxes.length > 0 && Array.from(allCheckboxes).every(cb => cb.checked);
            document.getElementById('selectAll').checked = allChecked;
        }

        function sortTable(table, column) {
            if (sortState.table === table && sortState.column === column) {
                sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortState.table = table;
                sortState.column = column;
                sortState.direction = 'asc';
            }
            updateUI();
        }

        function updateUI() {
            updateFileName();
            updateSummary();
            updateAccountsTable();
            updateStatementsTab();
            updateTransactionsTable();
            updateEnvelopesTable();
            updateTabIncompleteIndicators();
        }

        function updateFileName() {
            document.getElementById('fileName').textContent = ledgerData.fileName || 'No file loaded';
        }

        function getFilteredTransactions() {
            return selectedMonth === null ? ledgerData.transactions : ledgerData.transactions.filter(t => t.month === selectedMonth);
        }

        function getYTDTransactions() {
            return selectedMonth === null ? ledgerData.transactions : ledgerData.transactions.filter(t => t.month <= selectedMonth);
        }

        function calculateAccountBalances(transactions) {
            const balances = {};
            ledgerData.accounts.forEach(a => balances[a.id] = a.initialBalance || 0);
            transactions.forEach(t => { if (balances[t.accountId] !== undefined) balances[t.accountId] += t.amount; });
            return balances;
        }

        function updateSummary() {
            const ytdTrans = getYTDTransactions();
            const prevTrans = selectedMonth ? ledgerData.transactions.filter(t => t.month < selectedMonth) : [];
            const ytdBal = calculateAccountBalances(ytdTrans);
            const prevBal = calculateAccountBalances(prevTrans);

            let ytdA = 0, ytdL = 0, prevA = 0, prevL = 0;
            ledgerData.accounts.forEach(a => {
                const yb = ytdBal[a.id] || 0, pb = prevBal[a.id] || 0;
                if (yb >= 0) ytdA += yb; else ytdL += Math.abs(yb);
                if (pb >= 0) prevA += pb; else prevL += Math.abs(pb);
            });

            const ytdNW = ytdA - ytdL, prevNW = prevA - prevL;
            const deltaA = ytdA - prevA, deltaL = ytdL - prevL, deltaNW = ytdNW - prevNW;

            document.getElementById('netWorthYTD').textContent = formatCurrency(ytdNW);
            document.getElementById('netWorthYTD').className = ytdNW >= 0 ? 'summary-value positive' : 'summary-value negative';
            document.getElementById('netWorthDelta').textContent = formatCurrency(Math.abs(deltaNW));
            document.getElementById('netWorthDelta').className = deltaNW >= 0 ? 'summary-delta positive' : 'summary-delta negative';

            document.getElementById('totalAssetsYTD').textContent = formatCurrency(ytdA);
            document.getElementById('totalAssetsDelta').textContent = formatCurrency(Math.abs(deltaA));
            document.getElementById('totalAssetsDelta').className = deltaA >= 0 ? 'summary-delta positive' : 'summary-delta negative';

            document.getElementById('totalLiabilitiesYTD').textContent = formatCurrency(ytdL);
            document.getElementById('totalLiabilitiesDelta').textContent = formatCurrency(Math.abs(deltaL));
            document.getElementById('totalLiabilitiesDelta').className = deltaL >= 0 ? 'summary-delta negative' : 'summary-delta positive';
        }

        function updateAccountsTable() {
            const tbody = document.getElementById('accountsBody');
            if (ledgerData.accounts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="2"><div class="empty-state"><div class="empty-state-icon">📊</div><div class="empty-state-title">No accounts yet</div><p>Add your first account to start tracking</p></div></td></tr>';
                return;
            }
            
            const bal = calculateAccountBalances(getYTDTransactions());
            let accounts = ledgerData.accounts.map(a => ({ ...a, balance: bal[a.id] || 0 }));

            if (sortState.table === 'accounts') {
                accounts.sort((a, b) => {
                    let valA = sortState.column === 'name' ? a.name : a.balance;
                    let valB = sortState.column === 'name' ? b.name : b.balance;
                    if (typeof valA === 'string') valA = valA.toLowerCase();
                    if (typeof valB === 'string') valB = valB.toLowerCase();
                    return sortState.direction === 'asc' ? (valA > valB ? 1 : -1) : (valA < valB ? 1 : -1);
                });
            }

            tbody.innerHTML = accounts.map(a => 
                `<tr onclick="openAccountModal('${a.id}')"><td>${escapeHtml(a.name)}</td><td class="amount ${a.balance >= 0 ? 'positive' : 'negative'}">${formatCurrency(a.balance)}</td></tr>`
            ).join('');
        }

        function updateTransactionsTable() {
            const tbody = document.getElementById('transactionsBody');
            const filt = getFilteredTransactions();
            
            if (filt.length === 0) {
                const msg = selectedMonth ? 'No transactions for this month' : 'No transactions yet';
                const desc = selectedMonth ? 'Add transactions or select a different month' : 'Add your first transaction to start tracking';
                tbody.innerHTML = `<tr><td colspan="7"><div class="empty-state"><div class="empty-state-icon">💸</div><div class="empty-state-title">${msg}</div><p>${desc}</p></div></td></tr>`;
                selectedTransactions.clear();
                updateSelectionUI();
                return;
            }

            let sorted = [...filt];
            if (sortState.table === 'transactions') {
                sorted.sort((a, b) => {
                    let valA, valB;
                    switch(sortState.column) {
                        case 'date': valA = a.date; valB = b.date; break;
                        case 'month': valA = a.month; valB = b.month; break;
                        case 'account': 
                            const accA = ledgerData.accounts.find(x => x.id === a.accountId);
                            const accB = ledgerData.accounts.find(x => x.id === b.accountId);
                            valA = accA ? accA.name.toLowerCase() : '';
                            valB = accB ? accB.name.toLowerCase() : '';
                            break;
                        case 'description': valA = a.description.toLowerCase(); valB = b.description.toLowerCase(); break;
                        case 'envelope': valA = (a.envelope || '').toLowerCase(); valB = (b.envelope || '').toLowerCase(); break;
                        case 'amount': valA = a.amount; valB = b.amount; break;
                        default: valA = a.date; valB = b.date;
                    }
                    return sortState.direction === 'asc' ? (valA > valB ? 1 : -1) : (valA < valB ? 1 : -1);
                });
            } else {
                sorted.sort((a, b) => new Date(b.date) - new Date(a.date));
            }

            tbody.innerHTML = sorted.map((t, idx) => {
                const a = ledgerData.accounts.find(x => x.id === t.accountId);
                const color = t.envelope && ledgerData.envelopes[t.envelope] ? ledgerData.envelopes[t.envelope].color : '#2D5F3F';
                const checked = selectedTransactions.has(t.id) ? 'checked' : '';
                return `<tr onclick="handleTransactionClick('${t.id}', ${idx}, event)">
                    <td><input type="checkbox" ${checked} data-id="${t.id}"></td>
                    <td class="date">${formatDate(t.date)}</td>
                    <td>${getMonthName(t.month)}</td>
                    <td>${a ? escapeHtml(a.name) : 'Unknown'}</td>
                    <td>${escapeHtml(t.description)}</td>
                    <td>${t.envelope ? `<span class="envelope-tag" style="background-color:${color}20;color:${color};">${escapeHtml(t.envelope)}</span>` : '—'}</td>
                    <td class="amount ${t.amount >= 0 ? 'positive' : 'negative'}">${formatCurrency(t.amount)}</td>
                </tr>`;
            }).join('');

            updateSelectionUI();
        }

        // ─── Envelope Calculations ────────────────────────────────────────────────────

        // Get the effective funding for an envelope in a given month.
        // If there's no explicit entry for that month, walk back to the most recent prior month.
        // If none found, default to 0.
        function getEnvelopeFunding(name, month) {
            const env = ledgerData.envelopes[name];
            if (!env) return 0;
            const funding = env.funding || {};
            if (funding[month] !== undefined) return funding[month];
            // Walk backwards to find the most recent prior explicit funding
            for (let m = month - 1; m >= 1; m--) {
                if (funding[m] !== undefined) return funding[m];
            }
            return 0;
        }

        // Calculate envelope running total up through a given month (inclusive).
        // total(month) = sum of (funding(m) - withdrawals(m)) for m=1..month
        function calculateEnvelopeTotal(name, upToMonth) {
            let total = 0;
            const maxMonth = upToMonth === null ? 12 : upToMonth;
            for (let m = 1; m <= maxMonth; m++) {
                const funding = getEnvelopeFunding(name, m);
                const withdrawals = ledgerData.transactions
                    .filter(t => t.month === m && t.envelope === name && t.amount < 0)
                    .reduce((sum, t) => sum + Math.abs(t.amount), 0);
                total += funding - withdrawals;
            }
            return total;
        }

        function updateEnvelopesTable() {
            const tbody = document.getElementById('envelopesBody');
            const envNames = Object.keys(ledgerData.envelopes || {}).filter(n => n !== 'Transfer');

            if (envNames.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4"><div class="empty-state"><div class="empty-state-icon">📬</div><div class="empty-state-title">No envelopes yet</div><p>Add your first envelope to start budgeting</p></div></td></tr>`;
                return;
            }

            // Build rows with computed values
            const displayMonth = selectedMonth; // may be null (All)
            let rows = envNames.map(name => {
                const color = ledgerData.envelopes[name].color || '#2D5F3F';
                const funding = displayMonth ? getEnvelopeFunding(name, displayMonth) : 
                    Array.from({length:12},(_,i)=>i+1).reduce((s,m)=>s+getEnvelopeFunding(name,m),0);
                const withdrawals = (displayMonth
                    ? ledgerData.transactions.filter(t => t.month === displayMonth && t.envelope === name && t.amount < 0)
                    : ledgerData.transactions.filter(t => t.envelope === name && t.amount < 0)
                ).reduce((s,t) => s + Math.abs(t.amount), 0);
                const total = displayMonth ? calculateEnvelopeTotal(name, displayMonth) : calculateEnvelopeTotal(name, 12);
                return { name, color, funding, withdrawals, total };
            });

            if (sortState.table === 'envelopes') {
                rows.sort((a, b) => {
                    let vA, vB;
                    if (sortState.column === 'name') { vA = a.name.toLowerCase(); vB = b.name.toLowerCase(); }
                    else if (sortState.column === 'funding') { vA = a.funding; vB = b.funding; }
                    else if (sortState.column === 'withdrawals') { vA = a.withdrawals; vB = b.withdrawals; }
                    else { vA = a.total; vB = b.total; }
                    return sortState.direction === 'asc' ? (vA > vB ? 1 : -1) : (vA < vB ? 1 : -1);
                });
            } else {
                rows.sort((a, b) => a.name.toLowerCase() < b.name.toLowerCase() ? -1 : 1);
            }

            tbody.innerHTML = rows.map(r => {
                const bg = r.color + '20';
                return `<tr onclick="openEnvelopeModal('${escapeHtml(r.name)}')">
                    <td><span class="envelope-tag" style="background-color:${bg};color:${r.color};">${escapeHtml(r.name)}</span></td>
                    <td class="amount positive">${formatCurrency(r.funding)}</td>
                    <td class="amount ${r.withdrawals > 0 ? 'negative' : ''}">${r.withdrawals > 0 ? '-' : ''}${formatCurrency(r.withdrawals)}</td>
                    <td class="amount ${r.total >= 0 ? 'positive' : 'negative'}">${formatCurrency(r.total)}</td>
                </tr>`;
            }).join('');
        }

        // ─── Envelope Modal ───────────────────────────────────────────────────────────

        function openEnvelopeModal(name = null) {
            const isEdit = name !== null;
            document.getElementById('envelopeModalTitle').textContent = isEdit ? 'Edit Envelope' : 'Add Envelope';
            document.getElementById('envelopeId').value = name || '';
            document.getElementById('deleteEnvelopeBtn').style.display = isEdit ? 'block' : 'none';

            let color = '#2D5F3F';
            let fundingVal = '';

            if (isEdit && ledgerData.envelopes[name]) {
                const env = ledgerData.envelopes[name];
                document.getElementById('envelopeName').value = name;
                document.getElementById('envelopeName').readOnly = true; // name is the key, renaming would be complex
                color = env.color || '#2D5F3F';

                if (selectedMonth) {
                    const explicit = (env.funding || {})[selectedMonth];
                    const inherited = getEnvelopeFunding(name, selectedMonth);
                    fundingVal = explicit !== undefined ? explicit : '';
                    // Show hint about inherited value
                    const hint = document.getElementById('envelopeFundingHint');
                    if (explicit === undefined && selectedMonth > 1) {
                        hint.textContent = `Inheriting ${formatCurrency(inherited)} from a prior month. Enter a value to override.`;
                    } else if (explicit === undefined && selectedMonth === 1) {
                        hint.textContent = 'Defaults to $0.00 in January. Enter a value to set funding.';
                    } else {
                        hint.textContent = '';
                    }
                }
            } else {
                document.getElementById('envelopeName').value = '';
                document.getElementById('envelopeName').readOnly = false;
                document.getElementById('envelopeFundingHint').textContent = '';
            }

            // Show/hide funding field based on whether a month is selected
            const fundingGroup = document.getElementById('envelopeFundingGroup');
            const fundingLabel = document.getElementById('envelopeFundingMonthLabel');
            if (selectedMonth) {
                const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
                fundingGroup.style.display = 'block';
                fundingLabel.textContent = `for ${months[selectedMonth - 1]}`;
                document.getElementById('envelopeFunding').value = fundingVal;
            } else {
                fundingGroup.style.display = 'none';
            }

            envelopeModalColor = color;
            document.getElementById('envelopeModalColorPreview').style.background = color;
            document.getElementById('envelopeModalColorHex').value = color;

            // Wire up color picker
            document.querySelectorAll('#envelopeModal .color-preset').forEach(btn => {
                btn.onclick = (e) => { e.preventDefault(); selectEnvelopeModalColor(btn.dataset.color); };
                btn.classList.toggle('selected', btn.dataset.color.toLowerCase() === color.toLowerCase());
            });
            document.getElementById('envelopeModalColorHex').oninput = (e) => {
                if (/^#[0-9A-Fa-f]{6}$/.test(e.target.value)) selectEnvelopeModalColor(e.target.value);
            };

            document.getElementById('envelopeModal').classList.add('active');
            if (!isEdit) setTimeout(() => document.getElementById('envelopeName').focus(), 100);
        }

        function closeEnvelopeModal() {
            document.getElementById('envelopeModal').classList.remove('active');
            document.getElementById('envelopeName').readOnly = false;
        }

        function saveEnvelope() {
            const oldName = document.getElementById('envelopeId').value;
            const name = document.getElementById('envelopeName').value.trim();
            const color = envelopeModalColor;

            if (!name) return showMessage('Please enter an envelope name', 'error');

            const isEdit = oldName !== '';

            if (!isEdit) {
                // Creating new envelope
                if (ledgerData.envelopes[name]) return showMessage('An envelope with this name already exists', 'error');
                ledgerData.envelopes[name] = { color, funding: {} };
            } else {
                // Editing existing
                if (!ledgerData.envelopes[oldName]) return;
                ledgerData.envelopes[oldName].color = color;
            }

            // Save funding if a month is selected
            if (selectedMonth && document.getElementById('envelopeFundingGroup').style.display !== 'none') {
                const rawFunding = document.getElementById('envelopeFunding').value;
                const targetName = isEdit ? oldName : name;
                if (!ledgerData.envelopes[targetName].funding) ledgerData.envelopes[targetName].funding = {};
                if (rawFunding === '' || rawFunding === null) {
                    // Clear explicit override - revert to inheritance
                    delete ledgerData.envelopes[targetName].funding[selectedMonth];
                } else {
                    ledgerData.envelopes[targetName].funding[selectedMonth] = parseFloat(rawFunding) || 0;
                }
            }

            markUnsaved();
            updateUI();
            closeEnvelopeModal();
            showMessage(isEdit ? 'Envelope updated!' : 'Envelope added!');
        }

        function confirmDeleteEnvelope() {
            const name = document.getElementById('envelopeId').value;
            if (!name) return;
            pendingAction = { type: 'deleteEnvelope', name };
            document.getElementById('confirmModalTitle').textContent = 'Delete Envelope';
            document.getElementById('confirmModalBody').innerHTML = `<p>Are you sure you want to delete the <strong>${escapeHtml(name)}</strong> envelope? Transactions assigned to it will not be deleted, but will lose their envelope assignment.</p>`;
            document.getElementById('confirmActionBtn').textContent = 'Delete Envelope';
            document.getElementById('confirmActionBtn').className = 'danger';
            document.getElementById('confirmModal').classList.add('active');
        }

        function populateAccountSelects() {
            document.getElementById('transactionAccount').innerHTML = '<option value="">Select account...</option>' + ledgerData.accounts.map(a => `<option value="${a.id}">${escapeHtml(a.name)}</option>`).join('');
        }

        function populateTransferSelects() {
            const opts = ledgerData.accounts.map(a => `<option value="${a.id}">${escapeHtml(a.name)}</option>`).join('');
            document.getElementById('transferFrom').innerHTML = '<option value="">Select account...</option>' + opts;
            document.getElementById('transferTo').innerHTML = '<option value="">Select account...</option>' + opts;
        }

        function getMonthName(m) {
            return ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][m - 1] || '';
        }

        function formatCurrency(amt) {
            const abs = Math.abs(amt);
            const fmt = abs.toLocaleString('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2, maximumFractionDigits: 2 });
            return amt < 0 ? '-' + fmt : fmt;
        }

        function formatDate(d) {
            return new Date(d + 'T00:00:00').toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ─── Statements ──────────────────────────────────────────────────────────────

        function getStatementKey(accountId, month) {
            return `${accountId}::${month}`;
        }

        function isStatementsComplete(month) {
            if (!month) return true;
            const accountIds = ledgerData.accounts.map(a => a.id);
            if (accountIds.length === 0) return true;
            return accountIds.every(id => {
                return (ledgerData.statements || []).some(s => s.accountId === id && s.month === month);
            });
        }

        function updateTabIncompleteIndicators() {
            // Statements: incomplete when a month is selected and not all accounts have a statement
            const statementsBtn = document.querySelector('.tab[onclick="switchTab(\'statements\')"]');
            if (statementsBtn) {
                const incomplete = selectedMonth && ledgerData.accounts.length > 0 && !isStatementsComplete(selectedMonth);
                statementsBtn.classList.toggle('tab-incomplete', !!incomplete);
            }

            // Envelopes: incomplete when any envelope has a negative total in the current view
            const envelopesBtn = document.querySelector('.tab[onclick="switchTab(\'envelopes\')"]');
            if (envelopesBtn) {
                const envNames = Object.keys(ledgerData.envelopes || {}).filter(n => n !== 'Transfer');
                const checkMonth = selectedMonth;
                const anyNegative = envNames.some(name => {
                    const total = calculateEnvelopeTotal(name, checkMonth === null ? 12 : checkMonth);
                    return total < -0.005;
                });
                envelopesBtn.classList.toggle('tab-incomplete', envNames.length > 0 && anyNegative);
            }
        }

        function updateStatementsTab() {
            const tbody = document.getElementById('statementsBody');
            if (!tbody) return;

            const stmts = selectedMonth
                ? (ledgerData.statements || []).filter(s => s.month === selectedMonth)
                : (ledgerData.statements || []);

            if (stmts.length === 0) {
                const msg = selectedMonth ? 'No statements for this month' : 'No statements yet';
                const desc = selectedMonth ? 'Add a statement for each account to mark the month complete' : 'Add your first statement to start tracking';
                tbody.innerHTML = `<tr><td colspan="7"><div class="empty-state"><div class="empty-state-icon">🧾</div><div class="empty-state-title">${msg}</div><p>${desc}</p></div></td></tr>`;
                return;
            }

            tbody.innerHTML = stmts.map(s => {
                const account = ledgerData.accounts.find(a => a.id === s.accountId);
                const accountName = account ? escapeHtml(account.name) : 'Unknown';
                const expected = s.startBalance + s.deposits - s.withdrawals;
                const diff = Math.abs(expected - s.endBalance);
                const ok = diff < 0.005;
                const statusHtml = ok
                    ? `<span class="stmt-status ok" title="Balances check out">✓</span>`
                    : `<span class="stmt-status warn" title="Expected ending balance: ${formatCurrency(expected)} (diff: ${formatCurrency(diff)})">!</span>`;
                return `<tr onclick="openStatementModal('${s.id}')">
                    <td>${accountName}</td>
                    <td class="amount">${formatCurrency(s.startBalance)}</td>
                    <td class="amount">${formatCurrency(s.endBalance)}</td>
                    <td class="amount positive">${formatCurrency(s.deposits)}</td>
                    <td class="amount negative">-${formatCurrency(s.withdrawals)}</td>
                    <td class="date">${s.startDate ? formatDate(s.startDate) : '—'} – ${s.endDate ? formatDate(s.endDate) : '—'}</td>
                    <td style="text-align:center;">${statusHtml}</td>
                </tr>`;
            }).join('');
        }

        function openStatementModal(statementId = null) {
            if (ledgerData.accounts.length === 0) return showMessage('Please add an account first', 'error');

            // Populate account select
            document.getElementById('statementAccount').innerHTML =
                '<option value="">Select account...</option>' +
                ledgerData.accounts.map(a => `<option value="${a.id}">${escapeHtml(a.name)}</option>`).join('');

            if (statementId) {
                const s = (ledgerData.statements || []).find(x => x.id === statementId);
                if (s) {
                    document.getElementById('statementModalTitle').textContent = 'Edit Statement';
                    document.getElementById('statementId').value = s.id;
                    document.getElementById('statementAccount').value = s.accountId;
                    document.getElementById('statementMonth').value = s.month;
                    document.getElementById('statementStartDate').value = s.startDate || '';
                    document.getElementById('statementEndDate').value = s.endDate || '';
                    document.getElementById('statementStartBalance').value = s.startBalance;
                    document.getElementById('statementEndBalance').value = s.endBalance;
                    document.getElementById('statementDeposits').value = s.deposits;
                    document.getElementById('statementWithdrawals').value = s.withdrawals;
                    document.getElementById('deleteStatementBtn').style.display = 'block';
                    updateStatementSanityCheck();
                }
            } else {
                document.getElementById('statementModalTitle').textContent = 'Add Statement';
                document.getElementById('statementId').value = '';
                document.getElementById('statementForm').reset();
                document.getElementById('deleteStatementBtn').style.display = 'none';
                document.getElementById('statementSanityCheck').style.display = 'none';
                if (selectedMonth) document.getElementById('statementMonth').value = selectedMonth;
            }

            document.getElementById('statementModal').classList.add('active');
            setTimeout(() => document.getElementById('statementAccount').focus(), 100);

            // Live sanity check
            ['statementStartBalance','statementEndBalance','statementDeposits','statementWithdrawals'].forEach(id => {
                document.getElementById(id).addEventListener('input', updateStatementSanityCheck);
            });
        }

        function updateStatementSanityCheck() {
            const start = parseFloat(document.getElementById('statementStartBalance').value) || 0;
            const end = parseFloat(document.getElementById('statementEndBalance').value) || 0;
            const dep = parseFloat(document.getElementById('statementDeposits').value) || 0;
            const wit = parseFloat(document.getElementById('statementWithdrawals').value) || 0;
            const expected = start + dep - wit;
            const diff = Math.abs(expected - end);
            const box = document.getElementById('statementSanityCheck');
            if (dep === 0 && wit === 0 && start === 0 && end === 0) { box.style.display = 'none'; return; }
            box.style.display = 'block';
            if (diff < 0.005) {
                box.className = 'statement-sanity ok';
                box.textContent = '✓ Balances check out: ' + formatCurrency(start) + ' + ' + formatCurrency(dep) + ' – ' + formatCurrency(wit) + ' = ' + formatCurrency(expected);
            } else {
                box.className = 'statement-sanity warn';
                box.textContent = '⚠ Expected ending balance: ' + formatCurrency(expected) + ' (entered: ' + formatCurrency(end) + ', diff: ' + formatCurrency(diff) + ')';
            }
        }

        function closeStatementModal() {
            document.getElementById('statementModal').classList.remove('active');
        }

        function saveStatement() {
            const id = document.getElementById('statementId').value;
            const accountId = document.getElementById('statementAccount').value;
            const month = parseInt(document.getElementById('statementMonth').value);
            const startDate = document.getElementById('statementStartDate').value;
            const endDate = document.getElementById('statementEndDate').value;
            const startBalance = parseFloat(document.getElementById('statementStartBalance').value);
            const endBalance = parseFloat(document.getElementById('statementEndBalance').value);
            const deposits = parseFloat(document.getElementById('statementDeposits').value);
            const withdrawals = parseFloat(document.getElementById('statementWithdrawals').value);

            if (!accountId || !month || !startDate || !endDate || isNaN(startBalance) || isNaN(endBalance) || isNaN(deposits) || isNaN(withdrawals)) {
                return showMessage('Please fill in all required fields', 'error');
            }

            if (!ledgerData.statements) ledgerData.statements = [];

            // Check for duplicate (same account + month), excluding self
            const duplicate = ledgerData.statements.find(s => s.accountId === accountId && s.month === month && s.id !== id);
            if (duplicate) return showMessage('A statement already exists for this account and month', 'error');

            if (id) {
                const s = ledgerData.statements.find(x => x.id === id);
                if (s) Object.assign(s, { accountId, month, startDate, endDate, startBalance, endBalance, deposits, withdrawals });
            } else {
                ledgerData.statements.push({ id: Date.now().toString(), accountId, month, startDate, endDate, startBalance, endBalance, deposits, withdrawals });
            }

            markUnsaved();
            updateUI();
            closeStatementModal();
            showMessage(id ? 'Statement updated!' : 'Statement added!');
        }

        function confirmDeleteStatement() {
            const id = document.getElementById('statementId').value;
            if (!id) return;
            pendingAction = { type: 'deleteStatement', id };
            document.getElementById('confirmModalTitle').textContent = 'Delete Statement';
            document.getElementById('confirmModalBody').innerHTML = '<p>Are you sure you want to delete this statement?</p>';
            document.getElementById('confirmActionBtn').textContent = 'Delete Statement';
            document.getElementById('confirmActionBtn').className = 'danger';
            document.getElementById('confirmModal').classList.add('active');
        }

        document.querySelectorAll('.modal').forEach(m => {
            m.addEventListener('click', (e) => { if (e.target === m) m.classList.remove('active'); });
        });

        init();
    </script>
</body>
</html>
